# Stat447C Group Project: Bayesian Survival Analysis of Water Scarcity

This project performs a Bayesian survival analysis to model the time until countries reach high water scarcity levels, using data from the Kaggle "Global Water Consumption Dataset (2000-2024)". The analysis uses a hierarchical Weibull model implemented in Stan to account for regional variations and time-varying covariates.

## Team Members

*   Swapnil Dubey
*   Lawrence Ma

## Files

*   `cleaned_global_water_consumption.csv`: The input dataset.
*   `data_prep.R`: Loads the raw data, defines the survival outcome (time to first "High" scarcity level using the original categories), handles time-varying covariates, adds continental grouping, and saves the processed data (`processed_water_survival_data.rds`).
*   `eda.R`: Generates exploratory plots (histograms, boxplots using original data; Kaplan-Meier curves using processed survival summary) and saves them as PNG files.
*   `weibull_hierarchical_tvc.stan`: Stan model file defining the hierarchical Weibull survival model with time-varying covariates, using a piecewise exponential likelihood formulation.
*   `stan_model.R`: Loads processed data, scales covariates, prepares the data list, compiles and runs the Stan model, and saves the fit object (`stan_weibull_fit.rds`).
*   `processed_water_survival_data.rds`: Intermediate file. Output of `data_prep.R`, containing the data ready for modeling.
*   `stan_weibull_fit.rds`: Output of `stan_model.R`, containing the MCMC samples from the Bayesian model fit. Analysis of this object forms the basis of the results.
*   `*.png`: Output plots generated by `eda.R`.

## Workflow

1.  **Dependencies:** Ensure R is installed with required packages (`tidyverse`, `lubridate`, `survival`, `survminer`, `patchwork`, `cmdstanr`, `posterior`) and `cmdstanr` is configured.
2.  **Data Prep:** Run `Rscript data_prep.R` to generate `processed_water_survival_data.rds`.
3.  **EDA:** Run `Rscript eda.R` to generate PNG plots for review.
4.  **Stan Model:** Run `Rscript stan_model.R` to compile and run the sampler (may take several minutes), creating `stan_weibull_fit.rds`.
5.  **Analysis:** Load `stan_weibull_fit.rds` in R for posterior analysis, diagnostics checks, and generating report results.

## Project Notes & Challenges

*   **Initial Approach:** The project initially planned to compare Bayesian and Frequentist (Cox PH) survival models. However, the Cox model encountered numerical instability (separation issues) when including region as a fixed effect due to the small number of events per region. While stratification resolved this, we decided to focus solely on the Bayesian hierarchical model for the final report to allow for a more in-depth exploration of that approach.
*   **Scarcity Definition:** We are using the original `Water Scarcity Level` categories provided in the dataset, defining the event as the first time a country reaches "High". Exploratory work considered calculating a custom index, but we proceeded with the original definition for clarity and consistency with the existing survival analysis framework.
*   **Stan Diagnostics:** The Stan model initially showed some divergences. Increasing the `adapt_delta` setting to 0.95 significantly reduced these, resulting in a more reliable posterior sample. The final fit still had a very small number of divergences (<0.1%), which should be noted when interpreting results.
*   **Covariate Scaling:** Covariates were scaled (mean 0, sd 1) before being passed to Stan to improve sampler efficiency.
